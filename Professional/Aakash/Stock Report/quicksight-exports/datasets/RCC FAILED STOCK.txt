select stu_con.*, concat(stu_con.created_by,' (',up.first_name,' ' ,up.last_name,' )') as Transaction_by_name,case when substring(material_number,1,1)='9' then 'Starting with 9' else 'Not Starting with 9' end materialnumberstartwith9  from (select distinct  a.*,
 CASE
        WHEN mm.serial_number_profile = '0005' THEN 'Bar-Coded'
        ELSE 'Non Bar-Coded'
    END AS Material_type,
b.primary_batch,
c.secondary_batch,d.course_title,
-- d.effective_from as course_start_date,
-- d.effective_to as course_end_date,
n.course_start_date,
n.course_end_date,
ca.crse_attr_value,
e.registration_date,
e.academic_group_value as Stream,
e.student_name as student_name_std_app_dtl ,
f.business_area_desc,
g.aes_last_payment_dt  as last_payment_received 

,coalesce(rm.region_disp_val,'NA') region_disp_val,
coalesce(butm.business_unit_type_disp_val,'NA') branch_type
from (
select psid,application_id,
academic_career_value,--this column contains RCC or DLP
--'stream' as Stream,--this column not present
term,
term_value,course_id,
-- 'course_start_date' as course_start_date, --this column not present
-- 'course_end_date' as course_end_date,--this column not present
-- 'Registration_date'as Registration_date,--this column not present
plant_id,
business_area,
business_area_value as business_unit,
primary_batch_id,
secondary_batch_id,
program_action,
--'last payment received' as last_payment_received,--this column not present
material_number,
material_description,
barcode,
--'material quantity issued' as material_quantity_issued,--this column not present
sap_doc_id,
type,
-- transaction_type,
transaction_id,
"date_add"('minute', 330,issue_date) issue_date,
created_by,
updated_by,
"date_add"('minute', 330,created_on) created_on ,
"date_add"('minute', 330,updated_on) updated_on,
status,
reason,
is_deleted,
return_transaction_id,
student_name,
return_mode,
-- receipt_id,
-- remark,
cost_center
 from "phoenix-enrollment_service".stock_transaction_aud
 where academic_career_value='RCC' and STATUS = 'FAILED'
 ) a
 
 inner join (select material_id,material_description,serial_number_profile from (select material_id,material_description,serial_number_profile ,row_number() over(partition by material_id order by updated_on desc) rn  from "phoenix-enrollment_service".material_master ) where rn=1)  mm
on mm.material_id=a.material_number
 
left join 
(select id,batch_name as primary_batch from "phoenix-student_batch_service"."student_batch")b on a.primary_batch_id=b.id
left join
(select id,batch_name as secondary_batch from "phoenix-student_batch_service"."student_batch")c on a.secondary_batch_id=c.id
 left join
(select * from "phoenix-master_setup_service".course_catalog_course_detail) d on cast(a.course_id as varchar) =d.course_id

left join 
(select course_id,academic_term,business_area,course_start_date,
course_end_date from (select  course_id,academic_term,business_area,course_start_date,
course_end_date,row_number() over(partition by course_id,academic_term,business_area	
 order by transaction_id desc) rn from "phoenix_pricing_service".course_fees_processing_approval
  where course_fee_status='L2Approved') where rn=1)  n 
 on a.course_id  =n.course_id and a.term=n.academic_term and a.business_area=n.business_area

  left join
(SELECT * FROM "pserp-curriculum-management".PS_CRSE_ATTRIBUTES where CRSE_ATTR='CRCT') ca 
on cast(a.course_id as varchar) =ca.crse_id

left  join (select * from "phoenix-enrollment_service".student_application_details) e on a.course_id=e.course_id and a.psid=e.psid and a.application_id=e.application_id
left  join (select * from "phoenix-master_setup_service".business_area_master) f on  a.business_unit=f.business_area_disp_val

left JOIN
"phoenix-master_setup_service".business_area_region_master barm ON f.id = barm.business_area_id
    left JOIN
"phoenix-master_setup_service".business_area_business_unit_type_master babutm ON f.id = babutm.business_area_id
    left JOIN
"phoenix-master_setup_service".business_unit_type_master butm ON babutm.business_unit_type_id = butm.ID
    left JOIN
"phoenix-master_setup_service".region_master rm ON cast( barm.region_id as varchar(50)) = cast(rm.region_key as varchar(50))

left join
(select * from csprod.ps_aes_studentoneview)g on a.psid=g.emplid and cast(a.course_id as varchar)=g.crse_id and a.business_unit=g.business_unit and a.term_value=g.strm and g.adm_appl_nbr=a.application_id
) stu_con 
left join  "phoenix-authentication_service".user_profile up on up.employee_id=stu_con.created_by
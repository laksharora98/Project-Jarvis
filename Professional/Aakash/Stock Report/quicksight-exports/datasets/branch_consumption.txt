select bran_con.*,concat(coalesce(up.first_name,''),' ' ,coalesce(up.last_name,'')) as Employee_Name,concat(bran_con.created_by,' (',coalesce(up.first_name,''),' ' ,coalesce(up.last_name,''),' )')   as Transaction_by_name from (select distinct a.*,
CASE
        WHEN mm.serial_number_profile = '0005' THEN 'Bar-Coded'
        ELSE 'Non Bar-Coded'
    END AS Material_type,
case when substring(a.material_number,1,1)='9' then 'Starting with 9' else 'Not Starting with 9' end materialnumberstartwith9,
d.course_title,
e.academic_group_value as Stream,
coalesce(f.business_area_desc,'NA') business_area_desc,
coalesce(butm.business_unit_type_disp_val,'NA') as branch_type
,coalesce(rm.region_disp_val,'NA') region_disp_val

from (
select psid,application_id,
academic_career_value,--this column contains RCC or DLP
term_value,course_id,
plant_id,
business_area,
business_area_value as business_unit,
primary_batch_id,
secondary_batch_id,
program_action,
material_number,
material_description,
barcode,
sap_doc_id,
type,
transaction_id,
"date_add"('minute', 330,issue_date) issue_date,
created_by,
updated_by,
"date_add"('minute', 330,created_on) created_on,
"date_add"('minute', 330,updated_on) updated_on,
status,
reason,
is_deleted,
return_transaction_id,
student_name,
return_mode,
receipt_id,
remark,
uom,
cost_center
 from "phoenix-enrollment_service".stock_transaction_aud
 where type in ('BRANCH_ISSUANCE','BRANCH_RETURN') and STATUS = 'SUCCESS'
 ) a
inner join (select material_id,material_description,serial_number_profile from (select material_id,material_description,serial_number_profile ,row_number() over(partition by material_id order by updated_on desc) rn  from "phoenix-enrollment_service".material_master ) where rn=1)  mm
on mm.material_id=a.material_number
 left join
(select * from "phoenix-master_setup_service".course_catalog_course_detail) d on cast(a.course_id as varchar) =d.course_id
left  join (select * from "phoenix-enrollment_service".student_application_details) e on a.course_id=e.course_id and a.psid=e.psid and a.application_id=e.application_id

left join
(select * from "phoenix-master_setup_service".business_area_master)f on a.business_area=f.id

      left JOIN
    "phoenix-master_setup_service".business_area_region_master barm ON f.id = barm.business_area_id
        left JOIN
 "phoenix-master_setup_service".business_area_business_unit_type_master babutm ON f.id = babutm.business_area_id
        left JOIN
    "phoenix-master_setup_service".business_unit_type_master butm ON babutm.business_unit_type_id = butm.ID
        left JOIN
    "phoenix-master_setup_service".region_master rm ON cast( barm.region_id as varchar(50)) = cast(rm.region_key as varchar(50))
) bran_con
left join "phoenix-authentication_service".user_profile up
on up.employee_id=bran_con.created_by